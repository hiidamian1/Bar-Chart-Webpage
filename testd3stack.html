<!DOCTYPE html>

<html>
    <head>
        <meta charset="utf-8">
        <script src="https://d3js.org/d3.v5.min.js"></script>

        <style>
            .axis path,
            .axis line {
            	fill: none;
            	stroke: #000;
            	shape-rendering: crispEdges;
            }

            .x.axis path {
            	display: none;
            }

            body {
            	font: 10px arial;
            	text-align: center;
            }
        </style>
    </head>
    
    <body>
    </body>

	<script>
		//margins for graph
		const margin = {top:20, right:30, bottom:30, left:40};
		const width = 800-margin.left-margin.right;
		const height = 400-margin.top-margin.bottom;

		//x and y scale
		var yScale = d3.scaleLinear().rangeRound([height,0]);
		var xScale = d3.scaleBand().rangeRound([0,width],0.1,0.2);

		//colors
		var c10 = d3.scaleOrdinal(d3.schemeCategory10);

		//scalable vector graphic (svg)
		var svg = d3.select("body")
			.append("svg")
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
			.append("g")
			.attr("transform","translate(" + margin.left + "," + margin.right + ")");
		
		//load data
		d3.csv("https://raw.githubusercontent.com/neo4j-examples/neo4j-foodmart-dataset/master/data/sales.csv").then(function(data){

			//map store id to sales of each product and retrieve keys for d3.stack()
			var product_sales = new Map();
			var keys = new Set();

			for (var i = 0; i < data.length; i++){
				if (product_sales.has(+data[i].store_id)){
					if (product_sales.get(+data[i].store_id).hasOwnProperty(+data[i].product_id)){
						product_sales.get(+data[i].store_id)[+data[i].product_id] += 1;
					} else {
						product_sales.get(+data[i].store_id)[+data[i].product_id] = 1;
					}
					product_sales.get(+data[i].store_id)["total"] += 1;
				} else {
					product_sales.set(+data[i].store_id, {"total": 1, "store_id": +data[i].store_id});
				}
				keys.add(+data[i].product_id);
			}

			//make sure all keys are present in product_sales map by giving products that were not sold a value of 0
			for (var store of keys){
				for (var sales of product_sales.values()){
					if (!(store in sales)){
						sales[store] = 0;
					}
				}
			}

			//set domains of x and y scales. "total" is the total combined sales for that particular store			
			var yDomain = Array.from(product_sales.values()).map(vals => vals["total"]);

			yScale.domain([0,d3.max(yDomain)]);
			xScale.domain(Array.from(product_sales.keys()));

			var sorted_keys = Array.from(keys).sort();
			c10.domain(sorted_keys);

			//array of sales objects
			var sale_values_arr = Array.from(product_sales.values());

			//create x and y axes
			var xAxis = d3.axisBottom(xScale);
			var yAxis = d3.axisLeft(yScale);

			//create horizontal grid lines
			svg.append("g")
			.selectAll("g")
			.data(d3.stack().keys(sorted_keys)(sale_values_arr))
			.enter().append("g")
			.attr("class", "grid")
			.call(d3.axisLeft()
				.scale(yScale)
				.tickSize(-width, 0, 0)
				.tickFormat(''))
			//create bars
			.selectAll("rect")
						.data(function(d){
							return d;
						})
						.enter()
						.append("rect")
						.attr("class", "bar")
						.attr("width", xScale.bandwidth())
						.attr("fill", function(d, i){
							return c10(Math.random() * 10 * i);
						})
						//.attr("fill", "steelblue")
						.attr("y", function(d){
							return yScale(d[1]);
						})
						.attr("x", function(d){
							//console.log(xScale(d[0]));
							console.log(d);
							return xScale(d.data.store_id);
						})
						.attr("height", function(d){
							return yScale(d[0]) - yScale(d[1]);
						});
						/*.on("mouseenter", function (actual, i){
							d3.select(this).attr("opacity", 0.5);
						})
						.on("mouseleave", function (actual, i){
							d3.select(this).attr("opacity", 1);
						});*/

			svg.append("g")
			.attr("transform", "translate(0," + height + ")")
			.call(xAxis)
			.attr("class", "x axis");

			svg.append("g")
			.attr("class", "y axis")
			.call(yAxis);
			
		
		});
	</script>
</html>